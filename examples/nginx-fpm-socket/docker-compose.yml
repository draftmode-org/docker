version: "3.4"
services:
  php:
    container_name: php
    build:
      context: ./php
      dockerfile: .deploy/Dockerfile
      args:
        IMAGE_NAME: webfux/php82-fpm
        IMAGE_TAG: 1.1.0
      target: production
    working_dir: /var/app
    environment:
      PHP_FPM_LISTEN: /socket/fpm.sock
    volumes:
      - sockets:/socket

  webserver:
    container_name: webserver
    build:
      context: ./webserver
      dockerfile: .deploy/Dockerfile
      args:
        IMAGE_NAME: webfux/nginx
        IMAGE_TAG: 1.1.0
      target: production
    ports:
      - target: 80
        published: 80
    environment:
      - BASE_DOMAIN=webfux.io
      - WWW_SUB_DOMAIN=www.dev
      - API_SUB_DOMAIN=api.dev
      - API_SOCKET=/socket/fpm.sock
    volumes:
      - sockets:/socket

volumes:
  sockets:
